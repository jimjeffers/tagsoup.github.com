
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Day 4: Drunk and Pushing State - Phx Tag Soup</title>
  <meta name="author" content="Phx Tag Soup">

  
  <meta name="description" content="In the immortal words or of Colonel Sanders, I&#8217;m too drunk to write this blog post. But eff it (note: I don&#8217;t know if Colonel Sanders &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Phx Tag Soup" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Phx Tag Soup</a></h1>
  
    <h2>The soup is warm</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:TagSoup.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/how-to-contribute/">How To Contribute</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Day 4: Drunk and Pushing State</h1>
    
    
      <p class="meta">
        





  



<time datetime="2012-02-27T21:58:00-07:00" pubdate  data-updated="true" >Feb 27<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In the immortal words <del>or</del> <em>of</em> Colonel Sanders, I&#8217;m too drunk to write this blog post. But eff it (note: I don&#8217;t know if Colonel Sanders said that part). Don&#8217;t take this as a knock that I don&#8217;t care about this blog post because I do. The HTML5 history API is one of my favorite things ever (and Tony Camp is one of my personal heroes). If the HTML5 history API (or Tony Camp) came up to me and said, &#8220;Hey baby, I work to spec in all the latest browsers and degrade gracefully in the others. What are you doing later?&#8221; I would say, &#8220;Writing some code. See you later.&#8221; I love it so much, I gave a talk about it at a previous <a href="http://tagsoup.github.com/blog/2011/10/28/html5-history-api-with-luke-karrys/">Tag Soup meetup</a>. But here I am going to tell you how to convert your current Octopress blog into an Octopress blog that uses HTML5 pushState (and how to report bugs to me where I messed up, because I definitely did).</p>

<!--more-->


<p>But seriously I think the 4 turkey burgers (trying to watch my figure) I ate tonight match up well with the 5 vodka sodas (again, with the figure) I drank tonight, so we should be good to go to learn about some sweet, sweet HTML5 history.</p>

<h2>Can I use this?</h2>

<p>Short answer: yes. Long answer: maybe, but it&#8217;s complicated. The history API is great. Remember hashbangs (#!)? Of course you do, they are still in use at some big-time websites (including Twitter). <a href="http://storify.com/timhaines/hashbang-conversation">That was a mistake</a>. But there is a much better way. The history API enables you to change the entire URL (as long as it is the same domain) when you AJAX in some sweet new content. The part that is complicated goes by the ugly name of &#8220;partial browser support&#8221;.</p>

<p>I&#8217;m sure you all love feature detection. And I&#8217;m also sure that you love not being lied to. Now imagine if your feature detects lied to you. You would probably be upset. We all would. No one likes being lied to. So when Safari 5.1 is like &#8220;Oh what&#8217;s up Modernizr. The history API? I support that. No problem. Throw it at me.&#8221; You are gonna feel all warm and fuzzy inside until another supported browswer says &#8220;Oh yeah, I support that as well. But I do it differently than Safari. That browser is dumb. Seriously, that browser is so dumb it got hit by a parked car.&#8221; And you&#8217;re going to say, &#8220;Come on browsers. Can&#8217;t we all just get along. Don&#8217;t let native apps win!&#8221;</p>

<p>But there is a solution. Benjamin Lupton wrote <a href="https://github.com/balupton/History.js/">History.js</a>. It has <a href="https://github.com/balupton/History.js/issues?sort=comments&amp;direction=desc&amp;state=open">bugs</a> (including a bug where its pushState method won&#8217;t accept a URL with a hash which I have hit multiple times), but it also solves a lot of browser inconsistencies and it has tests. So I use it. This is a case where I don&#8217;t want to reinvent the wheel, so I&#8217;m going to use a well tested library that someone else has written. Yes, some of the bugs are a pain, but I&#8217;d rather start a project with it than without it.</p>

<h2>Show me some code!</h2>

<p>Oh yeah, sorry about that. I ramble when I&#8217;m drunk. So Octopress, you use it, you love it. It is static and fast. But you want to bypass the full page reloads. I have a solution for you (and I could use your help on improving it, see the last paragraph). Here is the basic flow that we want to follow in order to get some sweet JS that does what we need it to do:</p>

<ol>
<li>Capture internal link clicks</li>
<li>Prevent the default action</li>
<li>Use HTML pushState to register the interaction</li>
<li>Capture that interaction by listening to an event</li>
<li>Change our content</li>
<li>Execute any other miscellaneous JavaScript to change the state of our page</li>
</ol>


<p>Sound easy enough? It is!</p>

<h2>I just said show me some code and you rambled again. Seriously, show me some code.</h2>

<p>Yes. I promise I will show you some code. Let&#8217;s start with step 1. This is some code I yanked from <a href="https://gist.github.com/854622">Benjamin Lupton</a> and tweaked a little to work a bit better with Octopress. This code is a jQuery helper to grab any internal links. The idea is that we are only going to want to attach our click handlers to internal links. The meat of this code is where we assign a boolean value to <code>isInternalLink</code>. We are checking whether the href of the link is equal to the root url or if it doesn&#8217;t contain a colon. We also want to make sure that the href doesn&#8217;t start with a hash (there it being a named anchor) and also isn&#8217;t a link to the RSS feed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$.expr[':'].internal = function(obj, index, meta, stack) {
</span><span class='line'>  var $link = $(obj),
</span><span class='line'>      url = $link.attr('href') || '',
</span><span class='line'>      isInternalLink;
</span><span class='line'>
</span><span class='line'>  // Check link
</span><span class='line'>  isInternalLink = ((url.substring(0, rootUrl.length) === rootUrl || url.indexOf(':') === -1) && url.charAt(0) !== "#" && url.indexOf('atom.xml') === -1);
</span><span class='line'>
</span><span class='line'>  return isInternalLink;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<h2>Ajaxify?! I barely know her.</h2>

<p>Next, we want to to use another method I yanked from Benjamin. This is enables us to run the ajaxify() function against jQuery objects. The only trick here, is the bug I talked about earlier. We have to separate the hash from the clicked url and pass it to the pushState event listener through the first parameter, which is a data object that can contain any arbitrary data.</p>

<p>Another note worth mentioning is the second parameter of the pushState method. That accepts a title for the new page, but as far as I know, no browsers support it. Also when using the <code>ajaxify</code> function in this way, we don&#8217;t know the full title of the next page at this junction. This could be rearranged, but since the browsers don&#8217;t support it, I don&#8217;t see much reason for doing so <del>know</del> <em>now</em> (especially since we will update the title later).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$.fn.ajaxify = function() {
</span><span class='line'>  var $this = $(this);
</span><span class='line'>  
</span><span class='line'>  $this.find('a:internal').click(function(event) {
</span><span class='line'>    var $link = $(this),
</span><span class='line'>        url = $link.attr('href'),
</span><span class='line'>        hash = url.split('#')[1],
</span><span class='line'>        data = {};
</span><span class='line'>
</span><span class='line'>    // Continue as normal for cmd clicks etc
</span><span class='line'>    if (event.which == 2 || event.metaKey) {
</span><span class='line'>      return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if (hash) {
</span><span class='line'>      url = url.replace('#'+hash, '');
</span><span class='line'>      data.hash = hash;
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    // Ajaxify this link
</span><span class='line'>    History.pushState(data, null, url);
</span><span class='line'>    event.preventDefault();
</span><span class='line'>    return false;
</span><span class='line'>  });
</span><span class='line'>
</span><span class='line'>  // Chain
</span><span class='line'>  return $this;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<h2>Shhhhhhh! Listen.</h2>

<p>The history.js plugin exposes a <code>statechange</code> event to the <code>window</code>. If we listen for that event, we can capture any state changes and bend them to our will. Here is the code I am using on my blog.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$(window).bind('statechange', function() {
</span><span class='line'>  
</span><span class='line'>  var State = History.getState(),
</span><span class='line'>      url = State.url,
</span><span class='line'>      stateData = State.data,
</span><span class='line'>      hash = stateData.hash,
</span><span class='line'>      relativeUrl = url.replace(rootUrl, ''),
</span><span class='line'>      isHome = (relativeUrl === '/' || relativeUrl === '/index.html' || relativeUrl === "") ? true : false,
</span><span class='line'>      classMethod = (isHome) ? 'addClass' : 'removeClass',
</span><span class='line'>      dsScript = (isHome || relativeUrl.indexOf("blog/archives") > -1) ? 'count.js' : 'embed.js',
</span><span class='line'>      homeClass = 'blog-index';
</span><span class='line'>
</span><span class='line'>  $.ajax({
</span><span class='line'>    url: url,
</span><span class='line'>    dataType: 'html',
</span><span class='line'>    success: function(data) {
</span><span class='line'>      var $data = $(data),
</span><span class='line'>          $content = $data.find('#content > div'),
</span><span class='line'>          title = $data.filter('title').text(),
</span><span class='line'>          $gists = $content.find('.gist-holder'),
</span><span class='line'>          gistEmbeds = [];
</span><span class='line'>
</span><span class='line'>      $gists.each(function() {
</span><span class='line'>        var $gistHolder = $(this),
</span><span class='line'>            url = $gistHolder.data('gist-url'),
</span><span class='line'>            id = url.replace(/.*\.com\/([0-9]+)\.js.*/, '$1'),
</span><span class='line'>            file = url.split('?file=')[1];
</span><span class='line'>
</span><span class='line'>        gistEmbeds.push($.get('/embed-gist.php?id=' + id + ((file) ? '&file=' + file : ''), function(data) {
</span><span class='line'>          $gistHolder.html(data);
</span><span class='line'>        }));
</span><span class='line'>      });
</span><span class='line'>
</span><span class='line'>      $.when.apply($, gistEmbeds).done(function() {
</span><span class='line'>        $contentArea.html($content.html())[classMethod](homeClass).ajaxify();
</span><span class='line'>        addCodeLineNumbers();
</span><span class='line'>        disqus_identifier = url;
</span><span class='line'>        disqus_url = url;
</span><span class='line'>        disqus_function(dsScript);
</span><span class='line'>        twitter_sharing();
</span><span class='line'>        $('title').text(title);
</span><span class='line'>        _gaq.push(['_trackPageview', ((relativeUrl.charAt(0) === '/')?'':'/')+relativeUrl]);
</span><span class='line'>        
</span><span class='line'>        var currentPos = $body.scrollTop(),
</span><span class='line'>            $nav = $('nav[role="navigation"]'),
</span><span class='line'>            $scrollTo = (hash) ? $('#' + hash) : $nav,
</span><span class='line'>            scrollTo = $scrollTo.offset().top,
</span><span class='line'>            distance = (currentPos > $nav.position().top || hash) ? Math.abs(currentPos - scrollTo) : 0;
</span><span class='line'>        
</span><span class='line'>        if (distance > 0) {
</span><span class='line'>          $('html, body').animate({
</span><span class='line'>            scrollTop: scrollTo
</span><span class='line'>          }, distance, function() {
</span><span class='line'>            if (hash) window.location.hash = hash;
</span><span class='line'>          });
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>      });
</span><span class='line'>
</span><span class='line'>    }
</span><span class='line'>  });
</span><span class='line'>
</span><span class='line'>  return false;
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p><code>History.getState()</code> provides us with an object that contains the URL, title and data object from the link that was just clicked. Here is where it can get a bit hairy. HTML is HTML right? We should just be able to AJAX in the URL we want, parse out the specific content areas that interest us, and replace the old content areas with the new ones. Well, almost.</p>

<p>The only dynamic third-party JavaScript that inserts content on my blog are my gists. If you have other similar JavaScript on your blog, you may have to write some new code that does something similar.</p>

<p>For gists, the rub lies in where for each gist we include a script tag which write our code from GitHub to our page. This doesn&#8217;t <em>work</em> that well dynamically since it uses <code>document.write</code>. When <code>document.write</code> is used after the page is already loaded, is empties the content of the page, and inserts its new content. Pretty selfish, right? Well <code>document.write</code> may be an asshole, but that&#8217;s not the end of the world. I came up with a <a href="https://github.com/lukekarrys/lukecod.es/blob/master/source/embed-gist.php">server-side solution</a> for my blog, which will take some URL parameters and fetch the gist HTML for you. Ben Nadel also came with a solution earlier this year that uses an iFrame to override the <code>document.write</code> method. I love his way of doing it, because it all stays client-side, but I think the server-side method is a bit safer (since you aren&#8217;t overriding browser method).</p>

<p>In my method, I am locating any gists in the incoming HTML. If there are any, I ask my server-side script to supply me with the HTML for that gist. I am also pushing that result of that request (a JQuery Deferred object) to an array. Later I am asking that array to let me know when all of its gists have been loaded.</p>

<p>Once all gists have been loaded (or immediately if there were no gists), I take the new content, assign it an appropriate class and ajaxify its internal links (<code>$contentArea.html($content.html())[classMethod](homeClass).ajaxify();</code>). After that I run a whole bunch of JavaScript functions to make sure we handle all the interactions that will need to happen for each page.</p>

<h2>Any other interactions? Bueller? Bueller?</h2>

<p>There actually is! In our mobile media query, we use a select to change pages. This won&#8217;t work for us, since our code only captures the interaction of internal links <code>a</code> elements. We need to change the <code>getNav</code> function so the select will call pushState for us. My code is below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function getNav() {
</span><span class='line'>  var mobileNav = $('nav[role=navigation] fieldset[role=search]').after('&lt;fieldset class="mobile-nav">&lt;/fieldset>').next().append('&lt;select>&lt;/select>');
</span><span class='line'>  mobileNav.children('select').append('&lt;option value="">Navigate&hellip;&lt;/option>');
</span><span class='line'>  $('ul[role=main-navigation]').addClass('main-navigation');
</span><span class='line'>  $('ul.main-navigation a').each(function(link) {
</span><span class='line'>    mobileNav.children('select').append('&lt;option value="'+link.href+'">&raquo; '+link.text+'&lt;/option>');
</span><span class='line'>  });
</span><span class='line'>  $('ul.subscription a').each(function(link) {
</span><span class='line'>    mobileNav.children('select').append('&lt;option value="'+link.href+'">&raquo; '+link.text+'&lt;/option>');
</span><span class='line'>  });
</span><span class='line'>  mobileNav.children('select').bind('change', function(event) {
</span><span class='line'>    if (event.target.value) { 
</span><span class='line'>      if (!!(window.history && history.pushState)) {
</span><span class='line'>        History.pushState(null, null, event.target.value);
</span><span class='line'>      } else {
</span><span class='line'>        window.location.href = event.target.value;
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  });
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>THe new part is where we are binding the change of the select. If we have the history API at our disposal then we will call pushState, leaving <code>window.location.href</code> as a fallback.</p>

<h2>Woooo! Almost done.</h2>

<p>So far we have done almost everything we need to do. Except the last part about executing any miscellaneous JavaScript to keep our pages in working condition. You know what they say: 90% of the vodka takes 10% of the time to drink. Something like that. Anyway, here we go. In the code snippet above, you may notice functions called such as:</p>

<ol>
<li><code>addCodeLineNumbers()</code></li>
<li><code>disqus_function(dsScript)</code> including the prior setting of <code>disqus_identifier</code> and <code>disqus_url</code>.</li>
<li><code>twitter_sharing()</code></li>
<li><code>$('title').text(title)</code></li>
<li><code>_gaq.push(['_trackPageview', ((relativeUrl.charAt(0) === '/')?'':'/')+relativeUrl])</code></li>
</ol>


<p>The first three items are functions I created in the JavaScript code so that the code line numbers, Disqus and Twitter embeds would all work properly. Below I&#8217;m going to share those three snippets to ensure that you can get that code working for your site.</p>

<p>The first function (<code>addCodeLineNumbers</code>) already exists as a global function in <code>octopress.js</code>. This is good (although polluting the global namespace is normally frowned upon) because we can just call the function to add line numbers to any gist we have available in our new content.</p>

<p>The second function pertains to the Disqus comments.</p>

<figure class='code'><figcaption><span>disqus.html </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">disqus_shortname</span> <span class="o">=</span> <span class="s1">&#39;phxtagsoup&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">disqus_identifier</span> <span class="o">=</span> <span class="s1">&#39;http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">disqus_url</span> <span class="o">=</span> <span class="s1">&#39;http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// var disqus_developer = 1;       </span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">disqus_script</span> <span class="o">=</span> <span class="s1">&#39;embed.js&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">disqus_function</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_disqus_script</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">dsq</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span> <span class="nx">dsq</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span> <span class="nx">dsq</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">dsq</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">disqus_shortname</span> <span class="o">+</span> <span class="s1">&#39;.disqus.com/&#39;</span> <span class="o">+</span> <span class="nx">_disqus_script</span><span class="p">;</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dsq</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">disqus_function</span><span class="p">(</span><span class="nx">disqus_script</span><span class="p">);</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the main point I changed, was to assign the IIFE that ran the Disqus code to a function expression so I could call it with the appropriate script when it needed to be. On the home page, I call it with <code>count.js</code> if we are on the homepage and <code>embed.js</code> if we are on a post page (and therefore embedding comment thread).</p>

<p>I also do the same thing with the tweet button.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script type="text/javascript">
</span><span class='line'>    var twitter_sharing = function(){
</span><span class='line'>      var twitterWidgets = document.createElement('script');
</span><span class='line'>      twitterWidgets.type = 'text/javascript';
</span><span class='line'>      twitterWidgets.async = true;
</span><span class='line'>      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
</span><span class='line'>      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
</span><span class='line'>    };
</span><span class='line'>    twitter_sharing();
</span><span class='line'>  &lt;/script></span></code></pre></td></tr></table></div></figure>


<p>I assign the code to a function expression, which I can then run at my convenience. Normally this type of code is meant to only be called on the initial loading of a page, but since we are accepting the role of Dr. Frankenstein and taking code and making it into our own monster, we have to make it callable from other places.</p>

<p>The last two things I am doing don&#8217;t require code changes from anywhere else, but are important nonetheless. The first is to change the page title. This isn&#8217;t the most important thing, but you know that feeling when you have tons of tabs open and you can&#8217;t tell what it what based on the titles. Don&#8217;t be hostile towards your users! Show them an accurate page title and they will be happy and come back to your blog to read about how awesome your cats are!</p>

<p>Lastly, I am telling Google Analytics to track the pageview. You know how important this is. The only trick I am pulling here, is to make sure that the URL I am sending to Google starts with a <code>/</code> since I believe that is required (not 100% sure about that).</p>

<h2>Wake up! I&#8217;m about to do a recap.</h2>

<p>If you include the first three codeblocks on your pages and replace the other codeblocks (Disqus and Twitter) you should be good to go.</p>

<p><em>But wait there&#8217;s more!</em></p>

<p>Your mileage may vary (YMMV). I know that sucks to hear but there is good news. I definitely did not cover the edge cases on this one. My blog doesn&#8217;t have any videos or some of the other plugins. I would love to hear if you implement this code and find some JS that doesn&#8217;t work. Seriously, tell me where I am wrong or where my code falls short!</p>

<p>Peace out, and if you don&#8217;t chew Big Red, well it&#8217;s spicy and you&#8217;ll love it.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Phx Tag Soup</span></span>

      





  



<time datetime="2012-02-27T21:58:00-07:00" pubdate  data-updated="true" >Feb 27<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/drunk/'>drunk</a>, <a class='category' href='/blog/categories/html5/'>html5</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/pushstate/'>pushstate</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/" data-via="phxtagsoup" data-counturl="http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/02/27/day-4-drunk-and-pushing-state/">Day 4: Drunk and Pushing State</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/26/ill-show-you-mine-if-you-show-me-yours/">I'll Show You Mine if You Show Me Yours</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/25/optimize-my-stuff-and-junk/">Optimize My Stuff and Junk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/24/day-1-of-the-30-day-challenge/">Day 1 of the 30 Day Challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/22/polling-is-for-chumps/">Polling is for chumps - node.js with EventSource</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tagsoup">@tagsoup</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tagsoup',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("phxtagsoup", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/phxtagsoup" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @phxtagsoup</a>
  
</section>


Included file 'asides/googleplus.html' not found in _includes directory
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Phx Tag Soup -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'phxtagsoup';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/';
        var disqus_url = 'http://TagSoup.github.com/blog/2012/02/27/day-4-drunk-and-pushing-state/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type='text/javascript' src="http://konami-js.googlecode.com/svn/trunk/konami.js"></script>
<script type="text/javascript">
$.domReady(function(){
  
  var deviateMin = 5,
      deviateMax = 12;

  function random(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function deviate(num) {
      return (((random(1, 2) === 1) ? 1 : -1) * random(deviateMin, deviateMax)) + num;
  }
  
  konami = new Konami();
  konami.code = function() {
    var content = document.getElementById('main'),
        header = document.getElementById('header'),
        footer = document.getElementById('footer');

    window.onscroll = function() {
      content.style.margin = deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(0) + 'px';
      content.style.padding = deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(0) + 'px';
      footer.style.margin = deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(44) + 'px ' + deviate(0) + 'px';
      footer.style.padding = deviate(14) + 'px ' + deviate(55) + 'px ' + deviate(14) + 'px ' + deviate(55) + 'px';
      header.style.margin = deviate(0) + 'px ' + deviate(0) + 'px ' + deviate(44) + 'px ' + deviate(0) + 'px';
      header.style.padding = deviate(35) + 'px ' + deviate(55) + 'px ' + deviate(35) + 'px ' + deviate(55) + 'px';
    };
  };
  konami.load();
});
</script>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26533764-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>





</body>
</html>
